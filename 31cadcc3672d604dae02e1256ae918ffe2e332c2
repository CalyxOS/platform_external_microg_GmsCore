{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "cba24637_9971fc45",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1000062
      },
      "writtenOn": "2023-11-02T17:16:00Z",
      "side": 1,
      "message": "Oddly, with this change, com.google.android.gms_preferences.xml only contains calyx_prefs_version after a new install, not exposure_last_cleanup like it usually does. A reboot or restart of microG does cause exposure_last_cleanup to appear, but this is odd. Should check into this.",
      "revId": "31cadcc3672d604dae02e1256ae918ffe2e332c2",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "1f764345_f575b6f9",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1000062
      },
      "writtenOn": "2023-11-02T18:12:45Z",
      "side": 1,
      "message": "This must have been my confusion, or something may have changed. I tried without this patch, too (used the version CalyxOS is shipping); exposure_last_cleanup is added on boot apparently, but clearing or restarting microG is not enough; I was wrong when mentioning that in the above comment.\n\nOn-boot is still a decent guarantee that exposure_last_cleanup would be available for everyone with an existing install; however, we\u0027ve enhanced the checks now anyway, so we don\u0027t need to rely on that.",
      "parentUuid": "cba24637_9971fc45",
      "revId": "31cadcc3672d604dae02e1256ae918ffe2e332c2",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "467b244a_48703212",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1000062
      },
      "writtenOn": "2023-11-02T19:01:12Z",
      "side": 1,
      "message": "Without a corresponding SUW change, new installs with this change will have location features off if /product/etc/microg.xml is not present. (Existing installs should migrate okay.) Still doing full testing though.",
      "revId": "31cadcc3672d604dae02e1256ae918ffe2e332c2",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "a47deb77_38950484",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1000062
      },
      "writtenOn": "2023-11-02T21:22:15Z",
      "side": 1,
      "message": "Best to combine with I9dc049a0.\n\nTESTING\n\nI performed all of the tests below and the behavior was as described. At this point I\u0027m confident this change works as desired. Notably we do not include \"Request from Hotspot\" as a default so it will always be off unless the user turns it on. We can always have it default enabled later, but the focus of this change was matching existing behavior for this migration.\n\nExpected default prefs: checkin_enable_service\u003dtrue, gcm_enable_mcs_service\u003dtrue, location_wifi_learning\u003dtrue, location_cell_learning\u003dtrue, location_wifi_mls\u003dtrue, location_cell_mls\u003dtrue, location_geocoder_nominatim\u003dtrue\nPrefs file: /data/user/0/com.google.android.gms/shared_prefs/com.google.android.gms_preferences.xml\nAll tests with this change should be performed *without /product/etc/microg.xml present* for the microG Settings to reflect what is described, but the prefs file will be as described either way.\n\nTests:\n1. (Clean install test.) Perform clean install including this change. Before proceeding with SUW, check prefs file. It should contain calyx_prefs_version\u003d1, exposure_last_cleanup, and nothing else -- whether or not /product/etc/microg.xml is present. (There will also not be any other shared_prefs files present.) Proceed with SUW, with or without networking (doesn\u0027t matter), up to the microG page. Turn off the top toggle (which turns them all off), tap Next, and check the prefs file again. It should be the same. Go back and turn on the top toggle, turn OFF the notifications toggle and location toggles, then Next. It will now additionally contain the location prefs from the defaults above as false, and some other new prefs that are all either 0 or false (including gcm_enable_mcs_service\u003dfalse). Go back and turn on the notification toggle, then Next. Now checkin_enable_service\u003dtrue and gcm_enable_mcs_service\u003dtrue should be in the prefs file. Finally, go back and turn on the location toggle, then Next. All the default values from above should be set as true. Proceed through the install, open up microG Settings, and verify that everything is turned on as expected.\n2. (Upgrade test, SUW defaults, microG never opened.) Prior to upgrade, use a build without this change, in which the SUW was completed with defaults, and microG Settings was never opened. Check prefs file. It will be missing checkin_enable_service\u003dtrue and missing the location prefs from the defaults above; the only item listed as true should be gcm_enable_mcs_service. Upgrade to a build with this change. Still don\u0027t open microG Settings. Check prefs file. It should now contain calyx_prefs_version\u003d1 along with all of the expected default prefs above. Now open microG Settings. Confirm everything looks as expected.\n3. (Upgrade test, SUW microG options turned off, no microG to be opened.) Prior to upgrade, use a build without this change, in which the SUW was completed with microG toggles turned off. Check prefs file. It should not contain any of the expected default prefs at all. Upgrade to a build with this change. Check prefs file. It should not have changed at all, since microG was disabled and not allowed to run.\n4. (Upgrade test, SUW microG defaults, then microG opened and all turned off.) Prior to upgrade, have a build with microG without this change, in which the SUW was completed with defaults, but then microG Settings was opened and everything was turned off. Check prefs file. All the default prefs should be present but false instead of true. Upgrade to a build with this change. Check prefs file. Should have calyx_prefs_version\u003d1 but otherwise be the same. Open microG Settings. Everything should still be turned off.\n5. (Upgrade test, SUW microG *no notifications*, microG never opened.) Prior to upgrade, have a build with microG without this change, in which the SUW was completed with the microG push notification option turned off, and microG Settings was never opened. Check prefs file. It should not contain any of the expected default prefs as true, but will contain many values as false or 0. Upgrade to a build with this change. Still don\u0027t open microG Settings. Check prefs file. It should now contain calyx_prefs_version\u003d1 along with the location prefs from the defaults above as true. Now open microG Settings. Confirm everything looks as expected (everything off except the location settings).",
      "revId": "31cadcc3672d604dae02e1256ae918ffe2e332c2",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "950d47ef_642f0c25",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1000062
      },
      "writtenOn": "2023-11-02T21:22:49Z",
      "side": 1,
      "message": "Done here: I9dc049a0",
      "parentUuid": "467b244a_48703212",
      "revId": "31cadcc3672d604dae02e1256ae918ffe2e332c2",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d6a00497_004e230d",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1000062
      },
      "writtenOn": "2023-11-02T21:26:25Z",
      "side": 1,
      "message": "With this, /product/etc/microg.xml can be removed (a separate change)\n\n(Adding this comment because I don\u0027t want to forget)",
      "revId": "31cadcc3672d604dae02e1256ae918ffe2e332c2",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "344ecda7_418a8bfe",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1000062
      },
      "writtenOn": "2023-11-03T10:04:50Z",
      "side": 1,
      "message": "Also important and forgot to mention: the old UnifiedNlp pref fallback behavior was tested as working by manually placing location_backends and geocoder_backends sets (/product/etc/microg.xml as a reference) in /data/user/0/com.google.android.gms/shared_prefs/unified_nlp.xml. Can likely even just copy the whole /product/etc/microg.xml to that location.\n\nSo:\n6. Upgrade from a build prior to this change and the corresponding SUW change, where microG was never opened, but before upgrading, copy unified_nlp.xml over. After upgrading, location prefs won\u0027t be added to preferences xml as they otherwise would.\n7. Same but with the backends sets empty or just one missing.\n\n^ I would want to verify these again since I didn\u0027t properly document verifying them. Bonus if it was from an actual older microG to be fully real world.",
      "parentUuid": "a47deb77_38950484",
      "revId": "31cadcc3672d604dae02e1256ae918ffe2e332c2",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "a706584b_1e1beeac",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1000062
      },
      "writtenOn": "2023-11-03T14:42:50Z",
      "side": 1,
      "message": "I did some real-world tests *instead* of 6 and 7 and it was fine. Since we can\u0027t edit comments, I\u0027ll start the numbering from 8. (For testing, make sure the upgrade doesn\u0027t have /product/etc/microg.xml!):\n\n8. Begin with a build that has the microG prebuilt with UnifiedNlp, with commit 42edb30c38c264e00f51bd51f55c4935fc1e214f. Manually install the apks in the backends folder. Don\u0027t open microG Settings. Upgrade. There will still be no unified_nlp.xml or stored location settings, just as before the upgrade, and there will be no location settings in the main prefs. Open microG Settings. All the Location settings (except hotspot) should be on.\n9. Begin with the same build as 8. This time, turn the backends off. Upgrade, and the unified_nlp.xml will still be present with empty sets, just as before the upgrade. The main prefs will have no location settings. Open microG Settings, and the new location settings should all be off.\n10. Begin with the same build as 8. This time, turn the backends off and on again. Upgrade, and the unified_nlp.xml will still be present with filled-in sets, just as before the upgrade. The main prefs will have no location settings. Open microG settings, and the new location settings (except hotspot) should all be on, using the unified_nlp.xml values as fallback. (If you were to delete unified_nlp.xml at this point, the location settings would all turn off. This is confirmed, as long as /product/etc/microg.xml is gone.)\n11. Same as above test, but only turn off one of Deja Vu / MLS. After upgrade, the toggles should reflect that choice. (If you were to delete unified_nlp.xml at this point, the location settings would all turn off. This is confirmed, as long as /product/etc/microg.xml is gone.)\n\nSo I\u0027ve done tests 1-5 and 8-11, and all have worked as expected.\n\nThere\u0027s obviously a lot of other permutations possible but I don\u0027t foresee any issues.",
      "parentUuid": "344ecda7_418a8bfe",
      "revId": "31cadcc3672d604dae02e1256ae918ffe2e332c2",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "9aaedd95_66b198ec",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1000062
      },
      "writtenOn": "2023-11-03T14:47:58Z",
      "side": 1,
      "message": "Mistake in number 8\u0027s description: There *will* be location settings in the main prefs after upgrade when microG Settings has not been opened and SUW is all defaults, and that\u0027s how it should be; that\u0027s what our migration is meant to do. Double-checked that this is what happens. \n\n(Gerrit comments may not the best place to write things like this.)",
      "parentUuid": "a706584b_1e1beeac",
      "revId": "31cadcc3672d604dae02e1256ae918ffe2e332c2",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "4b780dd4_3dbe5ad2",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1000062
      },
      "writtenOn": "2024-07-03T13:18:35Z",
      "side": 1,
      "message": "See https://review.calyxos.org/c/CalyxOS/platform_prebuilts_calyx_microg/+/24151",
      "parentUuid": "d6a00497_004e230d",
      "revId": "31cadcc3672d604dae02e1256ae918ffe2e332c2",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "543a76ac_8f965111",
        "filename": "play-services-base/core/src/main/kotlin/org/microg/gms/settings/SettingsProvider.kt",
        "patchSetId": 2
      },
      "lineNbr": 109,
      "author": {
        "id": 1000000
      },
      "writtenOn": "2023-11-03T10:33:01Z",
      "side": 1,
      "message": "What do you mean here? We won\u0027t have `microg.xml` anymore, so there\u0027d be no fallback.",
      "revId": "31cadcc3672d604dae02e1256ae918ffe2e332c2",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "a9e452cd_38df1f8f",
        "filename": "play-services-base/core/src/main/kotlin/org/microg/gms/settings/SettingsProvider.kt",
        "patchSetId": 2
      },
      "lineNbr": 109,
      "author": {
        "id": 1000062
      },
      "writtenOn": "2023-11-03T13:27:43Z",
      "side": 1,
      "message": "If the user had a UnifiedNlp-enabled version of microG and they ever modified the location or geocoder backend toggles in microG Settings, doing so would have created a string set preference in either unified_nlp.xml or the main preferences xml, for location_backends and/or geocoder_backends. Those preferences, if set before, still exist in newer microG versions and continue to act as fallback values, with or without this change. I refer to them as \"fallback\" because they are the defaults in the event that the new *_mls, *_learning, wifi_moving prefs have not been set.\n\nIf the user did *not* make changes, then there will be no such string sets, so it will match missingSet (default) and use the values specified in the migration.",
      "parentUuid": "543a76ac_8f965111",
      "revId": "31cadcc3672d604dae02e1256ae918ffe2e332c2",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "d81554b5_c988f2b9",
        "filename": "play-services-base/core/src/main/kotlin/org/microg/gms/settings/SettingsProvider.kt",
        "patchSetId": 2
      },
      "lineNbr": 109,
      "author": {
        "id": 1000062
      },
      "writtenOn": "2023-11-03T14:42:50Z",
      "side": 1,
      "message": "To put it another way, the quirk is that, for our convenience, if the user didn\u0027t mess with the backends, we go ahead and do a migration which turns on our defaults according to microG\u0027s *new* location scheme, if the new scheme\u0027s prefs are missing too. So, missing UnifiedNlp location backends + missing new prefs means turn it all on, except hotspot; missing geocoder backends + missing new pref means turn on Nominatim.\n\nBut if the user *did* mess with the backends, what they did is still used as a fallback. Upstream can do a formal migration of those at some point if they want, but we don\u0027t need to.",
      "parentUuid": "a9e452cd_38df1f8f",
      "revId": "31cadcc3672d604dae02e1256ae918ffe2e332c2",
      "serverId": "35266860-6252-469c-a67d-185064479fc0"
    }
  ]
}